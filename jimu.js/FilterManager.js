// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define(["dojo/_base/declare","dojo/_base/lang","dojo/topic","esri/lang","./LayerInfos/LayerInfos"],function(p,e,h,q,n){var l=null,m=p(null,{_filters:null,layerInfos:null,constructor:function(){this._filters={};window.isBuilder?(h.subscribe("app/mapLoaded",e.hitch(this,this._onMapLoaded)),h.subscribe("app/mapChanged",e.hitch(this,this._onMapChanged))):(h.subscribe("mapLoaded",e.hitch(this,this._onMapLoaded)),h.subscribe("mapChanged",e.hitch(this,this._onMapChanged)));h.subscribe("widgetDestroyed",
e.hitch(this,this._onWidgetDestroyed))},getWidgetFilter:function(a,b){return e.getObject(a+".filterExprs."+b,!1,this._filters)},applyWidgetFilter:function(a,b,c,d,e,g){var f="object"===typeof a?a:null;f&&(a=f.layerId,b=f.widgetId,c=f.expression,d=f.enableMapFilter,e=f.useAND,g=f.zoomAfterFilter);this._setFilterExp(a,b,c,d,e);b=this.layerInfos.getLayerInfoById(a)||this.layerInfos.getTableInfoById(a);a=this.getFilterExp(a);null!==a&&b&&b.setFilter(a,{zoomAfterFilter:g})},_onMapLoaded:function(){this.layerInfos=
n.getInstanceSync();this._traversalFilter()},_onMapChanged:function(){this.layerInfos=n.getInstanceSync();this._traversalFilter()},_onWidgetDestroyed:function(a){for(var b in this._filters)if(this._filters[b]){var c=this._filters[b];if(c){var d=c.filterExprs,c=c.mapFilterControls;d&&delete d[a];c&&delete c[a]}}},_traversalFilter:function(){this.layerInfos.traversalAll(e.hitch(this,function(a){this._filters[a.id]||(this._filters[a.id]={definitionExpression:a.getFilter(),filterExprs:{},mapFilterControls:{}})}))},
_getPriorityOfMapFilter:function(a){a=e.getObject(a+".mapFilterControls",!1,this._filters);var b=0,c;for(c in a){var d=a[c];d.priority>b&&(b=d.priority)}return b},_getMapFilterControl:function(a){a=e.getObject(a+".mapFilterControls",!1,this._filters);var b=0,c=null,d;for(d in a){var k=a[d];k.priority>b&&(b=k.priority,c=k)}return c},_setFilterExp:function(a,b,c,d,k){var g=a+".filterExprs."+b,f=a+".mapFilterControls."+b;c?(e.setObject(g,c,this._filters),q.isDefined(d)&&(a=this._getPriorityOfMapFilter(a),
e.setObject(f,{enable:d,useAND:k,priority:a+1},this._filters))):(e.getObject(g,!1,this._filters)&&delete this._filters[a].filterExprs[b],e.getObject(f,!1,this._filters)&&delete this._filters[a].mapFilterControls[b])},getFilterExp:function(a,b){if(!this._filters[a])return null;var c=[],d=this._filters[a].definitionExpression,e=this._filters[a].filterExprs;a=this._getMapFilterControl(a);for(var g in e){var f=e[g];b&&0<=g.indexOf(b)||f&&c.push("("+f+")")}b=c.join(" AND ");return d&&a&&a.enable||d&&null===
a?b?a&&!1===a.useAND?"("+d+") OR "+b:"("+d+") AND "+b:d:b}});m.getInstance=function(){if(null===l)l=new m,window._filterManager=l;else return l};return m});