// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/html dojo/query dojo/topic dojo/on dojo/aspect dojo/keys dojo/i18n dojo/_base/config esri/dijit/InfoWindow esri/dijit/PopupMobile esri/InfoTemplate esri/request esri/arcgis/utils esri/geometry/Extent esri/geometry/Point esri/layers/FeatureLayer require ./utils jimu/LayerInfos/LayerInfos jimu/dijit/Message jimu/dijit/AppStatePopup ./MapUrlParamsHandler ./AppStateManager ./PopupManager ./FilterManager".split(" "),function(w,d,g,
f,n,l,k,p,x,y,z,A,B,C,D,E,u,F,G,q,m,H,v,I,J,K,L,M){var r=null,t=w(null,{appConfig:null,mapDivId:"",map:null,previousInfoWindow:null,mobileInfoWindow:null,isMobileInfoWindow:!1,layerInfosObj:null,constructor:function(a,b){this.appConfig=a.appConfig;this.urlParams=a.urlParams;this.id=this.mapDivId=b;this.appStateManager=K.getInstance(this.urlParams);this.popupManager=L.getInstance(this);this.filterManager=M.getInstance();this.nls=window.jimuNls;l.subscribe("appConfigChanged",d.hitch(this,this.onAppConfigChanged));
l.subscribe("syncExtent",d.hitch(this,this.onSyncExtent));l.subscribe("mapContentModified",d.hitch(this,this.onMapContentModified));k(window,"resize",d.hitch(this,this.onWindowResize));k(window,"unload",d.hitch(this,this.onUnload))},showMap:function(){this._showMap(this.appConfig)},_showMap:function(a){console.time("Load Map");a.map["3D"]?a.map.itemId?this._show3DWebScene(a):this._show3DLayersMap(a):a.map.itemId?this._show2DWebMap(a):console.log("No webmap found. Please set map.itemId in config.json.")},
onUnload:function(){this.appConfig.keepAppState&&this.appStateManager.saveWabAppState(this.map,this.layerInfosObj)},onWindowResize:function(){this.map&&this.map.resize&&(this.map.resize(),this.resetInfoWindow(!1))},getMapInfoWindow:function(){return{mobile:this._mapMobileInfoWindow,bigScreen:this._mapInfoWindow}},resetInfoWindow:function(a){a&&(this._mapInfoWindow=this.map.infoWindow,this._mapMobileInfoWindow&&(this._mapMobileInfoWindow.destroy(),n("div.esriMobileInfoView.esriMobilePopupInfoView").forEach(function(a){f.destroy(a)}),
n("div.esriMobileNavigationBar").forEach(function(a){f.destroy(a)})),this._mapMobileInfoWindow=new B(null,f.create("div",null,null,this.map.root)),this.isMobileInfoWindow=!1);m.inMobileSize()&&!this.isMobileInfoWindow?(this.map.infoWindow.hide(),this.map.setInfoWindow(this._mapMobileInfoWindow),this.isMobileInfoWindow=!0):!m.inMobileSize()&&this.isMobileInfoWindow&&(this.map.infoWindow.hide(),this.map.setInfoWindow(this._mapInfoWindow),this.isMobileInfoWindow=!1)},onSyncExtent:function(a){this.map&&
(a=new u(a.extent),this.map.setExtent(a))},_visitConfigMapLayers:function(a,b){g.forEach(a.map.basemaps,function(a,e){a.isOperationalLayer=!1;b(a,e)},this);g.forEach(a.map.operationallayers,function(a,e){a.isOperationalLayer=!0;b(a,e)},this)},_show3DLayersMap:function(a){q(["esri3d/Map"],d.hitch(this,function(b){var c;c=new b(this.mapDivId,{camera:a.map.mapOptions.camera});this._visitConfigMapLayers(a,d.hitch(this,function(a){this.createLayer(c,"3D",a)}));c.usePlugin=b.usePlugin;this._publishMapEvent(c)}))},
_show3DWebScene:function(a){this._getWebsceneData(a.map.itemId).then(d.hitch(this,function(b){q(["esri3d/Map"],d.hitch(this,function(c){var e=new c(this.mapDivId,a.map.mapOptions);g.forEach(b.itemData.operationalLayers,function(a){this.createLayer(e,"3D",a)},this);g.forEach(b.itemData.baseMap.baseMapLayers,function(a){a.type="tile";this.createLayer(e,"3D",a)},this);g.forEach(b.itemData.baseMap.elevationLayers,function(a){a.type="elevation";this.createLayer(e,"3D",a)},this);e.toc=b.itemData.toc;e.bookmarks=
b.itemData.bookmarks;e.tours=b.itemData.tours}))}))},_publishMapEvent:function(a){window._viewerMap=a;J.postProcessUrlParams(this.urlParams,a);console.timeEnd("Load Map");this.map?(this.map=a,this.resetInfoWindow(!0),console.log("map changed."),l.publish("mapChanged",this.map,this.layerInfosObj)):(this.map=a,this.resetInfoWindow(!0),l.publish("mapLoaded",this.map,this.layerInfosObj))},_getWebsceneData:function(a){return D({url:"http://184.169.133.166/sharing/rest/content/items/"+a+"/data",handleAs:"json"})},
_show2DWebMap:function(a){this._increasePointCount(a);a.map.mapOptions||(a.map.mapOptions={});var b=this._processMapOptions(a.map.mapOptions)||{};b.slider=!1;var c=a.map.portalUrl,e=a.map.itemId,b={mapOptions:b,bingMapsKey:a.bingMapsKey,usePopupManager:!0};if(!window.isBuilder&&!a.mode&&a.map.appProxy&&a.map.appProxy.mapItemId===a.map.itemId){var h=[];g.forEach(a.map.appProxy.proxyItems,function(a){a.useProxy&&a.proxyUrl&&h.push({url:a.sourceUrl,mixin:{url:a.proxyUrl}})});0<h.length&&(b.layerMixins=
h)}this._createWebMapRaw(c,e,this.mapDivId,b).then(d.hitch(this,function(b){var c=b.map;c.hideZoomSlider();c.infoWindow.resize(270,316);c.itemId=a.map.itemId;c.itemInfo=b.itemInfo;c.webMapResponse=b;c.enableSnapping({snapKey:x.copyKey});f.setStyle(c.root,"zIndex",0);c._initialExtent=c.extent;this.layerInfosObj=H.getInstanceSyncForInit(c,c.itemInfo);this.layerInfosObj.getLayerInfoArrayOfWebmap().forEach(function(a){a.getLayerObject().then(d.hitch(this,function(a){a&&d.setObject("_wabProperties.originalRefreshinterval",
a.refreshInterval,a)}),d.hitch(this,function(a){console.error("can't get layerObject",a)}))},this);a.map.mapRefreshInterval&&!a.map.mapRefreshInterval.useWebMapRefreshInterval&&this._updateRefreshInterval(a.map.mapRefreshInterval);this._showUnreachableLayersTitleMessage();this._publishMapEvent(c);setTimeout(d.hitch(this,this._checkAppState),500);this._addDataLoadingOnMapUpdate(c);this._hideError()}),d.hitch(this,function(a){console.error(a);this._showError(a);l.publish("mapCreatedFailed")}))},_increasePointCount:function(a){if("1"!==
window.queryObject.disableLargePointCountForTimeSlider&&"true"!==window.queryObject.disableLargePointCountForTimeSlider){var b=!1;m.visitElement(a,function(a){"widgets/TimeSlider/Widget"===a.uri&&(b=!0)});b&&(G.prototype.maxPointCountForAuto=35E3)}},_handleRefreshLayer:function(a){var b=a._mode._drawFeatures,c=a._mode._clearIIf,e=null;a._mode._drawFeatures=function(c,e){e&&"number"===typeof e.row&&"number"===typeof e.col&&a._mode._removeCell(e.row,e.col);b.apply(a._mode,arguments)};p.before(a,"refresh",
function(){e=a._mode._cellMap;a._mode._clearIIf=function(){}});p.after(a,"refresh",function(){a._mode._cellMap=e;a._mode._clearIIf=c});k(a,"update-start",function(){a.isUpdating=!0});k(a,"update-end",function(){a.isUpdating=!1})},_showError:function(a){a&&a.message&&f.create("div",{"class":"app-error load-map-error",innerHTML:a.message},document.body)},_hideError:function(){n("div.load-map-error",document.body).forEach(function(a){document.body.removeChild(a)})},_createWebMapRaw:function(a,b,c,e){return m.createWebMap(a,
b,c,e).then(d.hitch(this,function(a){return a}),d.hitch(this,function(h){console.error(h);if(h&&h instanceof Error&&h.message){var f=d.getObject("arcgis.utils.baseLayerError",!1,y.cache["esri/nls/jsapi/"+z.locale]);if(f&&0<=h.message.indexOf(f))return new v({message:window.jimuNls.map.basemapNotAvailable+window.jimuNls.map.displayDefaultBasemap}),E.getItem(b).then(d.hitch(this,function(b){b.itemData.spatialReference={wkid:102100,latestWkid:3857};b.itemData.baseMap={baseMapLayers:[{url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer",
opacity:1,layerType:"ArcGISTiledMapServiceLayer",visibility:!0,id:"defaultBasemap_0"}],title:"Topographic"};return m.createWebMap(a,b,c,e)}))}throw h;}))},_showUnreachableLayersTitleMessage:function(){var a=this.layerInfosObj.getUnreachableLayersTitle(),b="",c=window.jimuNls.map.layerLoadedError||"The layer, ${layers} cannot be added to the map.";c&&a&&0<a.length&&(g.forEach(a,d.hitch(this,function(a){b=b+a+", "})),new v({message:c.replace("${layers}",b)}))},_addDataLoadingOnMapUpdate:function(a){var b=
f.toDom('\x3cdiv class\x3d"map-loading"\x3eLoading...\x3c/div\x3e');f.place(b,a.root);a.updating&&f.addClass(b,"loading");k(a,"update-start",d.hitch(this,function(){f.addClass(b,"loading")}));k(a,"update-end",d.hitch(this,function(){f.removeClass(b,"loading")}));k(a,"unload",d.hitch(this,function(){f.destroy(b);b=null}))},_checkAppState:function(){var a="extent center marker find query scale level".split(" "),b=this.appConfig.keepAppState;b&&g.forEach(a,function(a){a in this.urlParams&&(b=!1)},this);
b&&this.appStateManager.getWabAppState().then(d.hitch(this,function(a){if(a.extent||a.layers){var b=new I({nls:{title:this.nls.appState.title,restoreMap:this.nls.appState.restoreMap}});b.placeAt("main-page");k(b,"applyAppState",d.hitch(this,function(){this._applyAppState(a,this.map)}));b.startup();b.show()}}))},_applyAppState:function(a,b){this.layerInfosObj.restoreState({layerOptions:a.layers||null});a.extent&&b.setExtent(a.extent)},_processMapOptions:function(a){if(a)return a.lods||delete a.lods,
a.lods&&0===a.lods.length&&delete a.lods,a=d.clone(a),a.extent&&(a.extent=new u(a.extent)),a.center&&!d.isArrayLike(a.center)&&(a.center=new F(a.center)),a.infoWindow&&(a.infoWindow=new A(a.infoWindow,f.create("div",{},this.mapDivId))),a},createLayer:function(a,b,c){q([{"2D_tiled":"esri/layers/ArcGISTiledMapServiceLayer","2D_dynamic":"esri/layers/ArcGISDynamicMapServiceLayer","2D_image":"esri/layers/ArcGISImageServiceLayer","2D_feature":"esri/layers/FeatureLayer","2D_rss":"esri/layers/GeoRSSLayer",
"2D_kml":"esri/layers/KMLLayer","2D_webTiled":"esri/layers/WebTiledLayer","2D_wms":"esri/layers/WMSLayer","2D_wmts":"esri/layers/WMTSLayer","3D_tiled":"esri3d/layers/ArcGISTiledMapServiceLayer","3D_dynamic":"esri3d/layers/ArcGISDynamicMapServiceLayer","3D_image":"esri3d/layers/ArcGISImageServiceLayer","3D_feature":"esri3d/layers/FeatureLayer","3D_elevation":"esri3d/layers/ArcGISElevationServiceLayer","3D_3dmodle":"esri3d/layers/SceneLayer"}[b+"_"+c.type]],d.hitch(this,function(b){var e,f={};e="label url type icon infoTemplate isOperationalLayer".split(" ");
for(var g in c)0>e.indexOf(g)&&(f[g]=c[g]);c.infoTemplate?(e=new C(c.infoTemplate.title,c.infoTemplate.content),f.infoTemplate=e,b=new b(c.url,f),c.infoTemplate.width&&c.infoTemplate.height&&p.after(b,"onClick",d.hitch(this,function(){a.infoWindow.resize(c.infoTemplate.width,c.infoTemplate.height)}),!0)):b=new b(c.url,f);b.isOperationalLayer=c.isOperationalLayer;b.label=c.label;b.icon=c.icon;a.addLayer(b)}))},onAppConfigChanged:function(a,b,c){this.appConfig=a;"mapChange"===b?this._recreateMap(a):
"mapOptionsChange"===b?c.lods&&this._recreateMap(a):"mapRefreshIntervalChange"===b&&this.map&&this.map.itemInfo.itemData&&this.layerInfosObj&&this._updateRefreshInterval(c)},onMapContentModified:function(){this._recreateMap(this.appConfig)},_updateRefreshInterval:function(a){var b=-1,b=a.useWebMapRefreshInterval?-1:a.minutes;this.layerInfosObj.getLayerInfoArrayOfWebmap().forEach(function(a){a.getLayerObject().then(d.hitch(this,function(a){if(a){var c=d.getObject("_wabProperties.originalRefreshinterval",
!1,a);0<c&&"function"===typeof a.setRefreshInterval&&(0>b?a.setRefreshInterval(c):a.setRefreshInterval(b))}}),d.hitch(this,function(a){console.error("can't get layerObject",a)}))},this)},_recreateMap:function(a){this.map&&(l.publish("beforeMapDestory",this.map),this.map.destroy());this._showMap(a)},disableWebMapPopup:function(){this.map.setInfoWindowOnClick(!1)},enableWebMapPopup:function(){this.map.setInfoWindowOnClick(!0)}});t.getInstance=function(a,b){null===r&&(r=new t(a,b));return r};return t});