// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/Deferred dojo/_base/lang dojo/_base/array dojo/topic dojo/on esri/layers/FeatureLayer esri/layers/GraphicsLayer esri/geometry/geometryEngine esri/graphic esri/Color esri/symbols/SimpleMarkerSymbol esri/symbols/SimpleLineSymbol esri/symbols/SimpleFillSymbol".split(" "),function(w,r,f,g,k,x,h,y,n,l,p,t,u,v){var m=null,q=w(null,{constructor:function(){window.isBuilder?(k.subscribe("app/mapLoaded",f.hitch(this,this._onMapLoaded)),k.subscribe("app/mapChanged",f.hitch(this,
this._onMapChanged))):(k.subscribe("mapLoaded",f.hitch(this,this._onMapLoaded)),k.subscribe("mapChanged",f.hitch(this,this._onMapChanged)))},_displayLayers:{},previousMapScale:null,setSelectionSymbol:function(a){var b=a.geometryType,e=new t(t.STYLE_CIRCLE,16,null,p.fromArray([0,255,255])),c=new u(u.STYLE_SOLID,p.fromArray([0,255,255]),2),d=new v(v.STYLE_SOLID,c,p.fromArray([0,255,255,.3]));"esriGeometryPoint"===b?a.setSelectionSymbol(e):"esriGeometryPolyline"===b?a.setSelectionSymbol(c):"esriGeometryPolygon"===
b&&a.setSelectionSymbol(d)},updateSelectionByFeatures:function(a,b,e){0<b.length&&(b=g.map(b,f.hitch(this,function(b){var c=null,c=0<=a.graphics.indexOf(b)?new l(b.toJson()):b;c.wabIsTemp=!0;return c})));a.getSelectionSymbol()||this.setSelectionSymbol(a);var c=new r;a._selectHandler({features:b},e,null,null,c);this._isLayerNeedDisplayLayer(a)&&(this._displayLayers[a.id]||(this._displayLayers[a.id]=this._createDisplayLayer(a)),this._updateDisplayLayer(a,b,e));return c},getDisplayLayer:function(a){return this._displayLayers[a]},
setSelection:function(a,b){return this.updateSelectionByFeatures(a,b,h.SELECTION_NEW)},addFeaturesToSelection:function(a,b){return this.updateSelectionByFeatures(a,b,h.SELECTION_ADD)},removeFeaturesFromSelection:function(a,b){return this.updateSelectionByFeatures(a,b,h.SELECTION_SUBTRACT)},clearSelection:function(a){var b=new r;this.clearDisplayLayer(a);a.clearSelection();b.resolve();return b},clearDisplayLayer:function(a){(a=this._displayLayers[a.id])&&a.clear()},getClientFeaturesByGeometry:function(a,
b,e){return g.filter(a.graphics,f.hitch(this,function(a){return e?n.contains(b,a.geometry):n.intersects(b,a.geometry)}))},getUnionGeometryBySelectedFeatures:function(a){var b=null;a=a.getSelectedFeatures();0<a.length&&(b=g.map(a,f.hitch(this,function(a){return a.geometry})),b=n.union(b));return b},_createDisplayLayer:function(a){var b=new y,e=a.objectIdField;b.fields=a.fields;b.id="displayLayer_of_"+a.id;this.map.addLayer(b);if(!this.map.spatialReference.equals(a.spatialReference)||a.hasWebGLSurface()){var c=
a.getSelectionSymbol();x(a,"update-end",f.hitch(this,function(){var d=Math.round(this.map.getScale());if(this.previousMapScale!==d&&b.graphics&&0<b.graphics.length){this.previousMapScale=d;var z=g.map(b.graphics,function(a){return a.attributes[e]}),d=g.filter(a.graphics,function(a){return 0<=z.indexOf(a.attributes[e])});b.clear();g.forEach(d,f.hitch(this,function(a){a=new l(a.toJson());a.setSymbol(c);b.add(a)}))}}))}return b},_updateDisplayLayer:function(a,b,e){var c=this._displayLayers[a.id],d=a.getSelectionSymbol();
a.hasWebGLSurface()?this._updateDisplayLayerWebGL(a,c,d,b,e):(b=a.getSelectedFeatures(),this.clearDisplayLayer(a),g.forEach(b,f.hitch(this,function(a){a.visible&&(a.setSymbol(null),a=new l(a.toJson()),a.setSymbol(d),c.add(a))})))},_updateDisplayLayerWebGL:function(a,b,e,c,d){d===h.SELECTION_NEW&&(a._selectedFeaturesWebGL={});d===h.SELECTION_NEW||d===h.SELECTION_ADD?g.forEach(c,f.hitch(this,function(b){b.visible&&(a._selectedFeaturesWebGL[b.attributes[a.objectIdField]]=b)})):d===h.SELECTION_SUBTRACT&&
g.forEach(c,f.hitch(this,function(b){b=b.attributes[a.objectIdField];b in a._selectedFeaturesWebGL&&delete a._selectedFeaturesWebGL[b]}));this.clearDisplayLayer(a);for(var k in a._selectedFeaturesWebGL)c=new l(a._selectedFeaturesWebGL[k].toJson()),c.setSymbol(e),b.add(c)},_isLayerNeedDisplayLayer:function(a){return a.hasWebGLSurface()||!a.getMap()},_onMapLoaded:function(a){this.map=a},_onMapChanged:function(a){this.map=a}});q.getInstance=function(){m||(m=new q,window._selectionManager=m);return m};
return q});