// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define(["dojo/_base/lang","moment/moment","./_chartHelpUtils","jimu/utils","libs/moment/twix"],function(q,l,r,n){window.makeTwix&&window.makeTwix(l);return{getClietStatisticsData:function(a){var b=a.mode;if("feature"===b)return this.getFeatureModeStatisticsData(a);if("category"===b)return this.getCategoryModeStatisticsData(a);if("count"===b)return this.getCountModeStatisticsData(a);if("field"===b)return this.getFieldModeStatisticsData(a)},sortClientStatisticsData:function(a,b,d){return this.sortStatisticsData(a,
b.mode,b.sortOrder,b.clusterField,b.valueFields,d)},getDataForMaxLabels:function(a,b){return a&&a.length&&"number"===typeof b&&0<b&&b<a.length?a.slice(0,b):a},getFeatureModeStatisticsData:function(a){var b=a.features,d=a.clusterField,c=a.valueFields;a=void 0!==a.showNullLabelData?a.showNullLabelData:!0;var e=this.separateFeaturesWhetherFieldValueNull(d,b),b=e.notNullLabelFeatures,e=e.nullLabelFeatures,b=a?b.concat(e):b;a=[];return a=b.map(function(a){var b=a.attributes,g=b&&b[d],g=this.convertingNullOrUndefinedAsPlaceholders(g);
a={label:g,values:[],features:[a]};a.values=c.map(function(a){return b[a]});return a}.bind(this))},getCategoryModeStatisticsData:function(a){function b(a){var b=[],f=null,p;for(p in a){f=a[p];p=this.keepFieldValueType(p,f.type,g);var h=this.calcValuesByFeaturesForCatetoryMode(c,f,d,e,m);b.push({label:p,values:h,features:f.features,unit:f.unit})}return b}var d=a.hasStatisticsed,c=a.valueFields,e=a.operation,g=a.dateConfig,h=void 0!==a.showNullLabelData?a.showNullLabelData:!0,m=a.nullValue,f=[],f=this.getCluseringObj(a.clusterField,
a.features,g);a=f.nullLabel;f=b.call(this,f.notNullLabel);a=b.call(this,a);return f=h?f.concat(a):f},getCountModeStatisticsData:function(a){function b(a){var b=[],c=null,e;for(e in a){var c=a[e],h=this.calcValuesByFeaturesForCountMode(c,g);e=this.keepFieldValueType(e,c.type,d);b.push({label:e,values:h,features:c.features,unit:c.unit})}return b}var d=a.dateConfig,c=void 0!==a.showNullLabelData?a.showNullLabelData:!0,e=[],g=a.hasStatisticsed&&!d,e=this.getCluseringObj(a.clusterField,a.features,d);a=
e.nullLabel;e=b.call(this,e.notNullLabel);a=b.call(this,a);return e=c?e.concat(a):e},calcValuesByFeaturesForCountMode:function(a,b){return b?a.features.map(function(a){var b=(a=a.attributes)&&a.STAT_COUNT;"undefined"===typeof b&&(b=a.stat_count);return b}.bind(this)):[a.count]},getFieldModeStatisticsData:function(a){var b=a.hasStatisticsed,d=a.features,c=a.operation,e=a.nullValue,g=[];return g=a.valueFields.map(q.hitch(this,function(a){var g=this.getValuesByValueFieldForFieldMode(a,d,b,c),g=this.calcValueByOperation(g,
c,e);return{label:a,values:[g]}}))},getValueFromAttributes:function(a,b,d,c){if(a)return d="average"===d?"avg":d,c?(c=n.upperCaseString(b+"_"+d),c=a[c],"undefined"===typeof c&&(c=n.lowerCaseString(b+"_"+d),c=a[c])):c=a[b],c},getValuesByValueFieldForFieldMode:function(a,b,d,c){return b.map(q.hitch(this,function(b){return this.getValueFromAttributes(b.attributes,a,c,d)}))},sortStatisticsData:function(a,b,d,c,e,g){function h(a,b,d){var g;if("category"===b)d.isLabelAxis?d.isLabelAxis&&(g=a.label):d.field||
1!==a.values.length?(d=e.indexOf(d.field),g=a.values[d]):g=a.values[0];else if("count"===b)g=a.label,g=d.isLabelAxis?g:a.values[0];else if("field"===b)g=d.isLabelAxis?a.label:a.values[0];else if("feature"===b){var f=d.field;a&&a.features&&a.features[0]&&(b=a.features[0].attributes)&&(d.isLabelAxis?g=b[c]:f?g=b[f]:a.values.length&&(g=a.values[0]))}return g}if(!d)return a;var m=d.isAsc;if(!Array.isArray(a))return a;a.sort(function(a,e){a=h(a,b,d);e=h(e,b,d);if(d.isLabelAxis&&g&&"field"!==b){var f={};
f[c]=a;var f=n.getDisplayValueForCodedValueOrSubtype(g,c,f),k={};k[c]=e;k=n.getDisplayValueForCodedValueOrSubtype(g,c,k);f.isCodedValueOrSubtype&&k.isCodedValueOrSubtype&&(a=f.displayValue,e=k.displayValue)}"_NULL\x26UNDEFINED_"===a&&(a=Infinity);"_NULL\x26UNDEFINED_"===e&&(e=Infinity);n.isNumberOrNumberString(a)&&(a=Number(a));n.isNumberOrNumberString(e)&&(e=Number(e));f=a>e?m:!m;Infinity===a?f=m:Infinity===e&&(f=!m);k=0;a!==e&&(k=f?1:-1);return k}.bind(this));return a},convertingNullOrUndefinedAsPlaceholders:function(a){return null===
a||void 0===a?"_NULL\x26UNDEFINED_":a},keepFieldValueType:function(a,b,d){"number"===b&&(a=Number(a));d&&"_NULL\x26UNDEFINED_"!==a&&(a=Number(a));return a},calcValuesByFeaturesForCatetoryMode:function(a,b,d,c,e){return a.map(function(a){a=this.getValuesByValueFieldForCategoryMode(a,b.features,d,c);return this.calcValueByOperation(a,c,e)}.bind(this))},getValuesByValueFieldForCategoryMode:function(a,b,d,c){return b.map(q.hitch(this,function(b){return this.getValueFromAttributes(b.attributes,a,c,d)}))},
_isNumber:function(a){return"[object number]"===Object.prototype.toString.call(a).toLowerCase()},_getDateUnit:function(a,b){var d=b;"automatic"===b&&(b=l(a[0]).local(),a=l(a[1]).local(),a=Math.round(a.diff(b,"minute",!0)),0<=a&&1>=a?d="second":1<a&&60>=a?d="minute":60<a&&1440>=a?d="hour":1440<a&&43200>=a?d="day":43200<a&&518400>=a?d="month":518400<a&&(d="year"));return d},_getTimeRange:function(a,b){var d=a.map(q.hitch(this,function(a){return(a=a.attributes)&&a[b]})),d=d.filter(function(a){return!!a});
a=Math.min.apply(Math,d);d=Math.max.apply(Math,d);return[a,d]},_getTimeTwixs:function(a,b,d){if(0>"year quarter month day hour minute second automatic".split(" ").indexOf(d))return console.log("Invaild data formatter: "+d),!1;a=this._getTimeRange(a,b);if(a[0]===a[1])return!1;d=this._getDateUnit(a,d);b=this.getStartTimeByUnit(a[0],d);b=l(b).local();a=l(a[1]).local();a=b.twix(a).split(1,d);b={startValue:a[a.length-1].end().valueOf(),endValue:Infinity};a.push(b);return{twixs:a,dateUnit:d}},getCluseringObj:function(a,
b,d){var c={},e={};d?(a=this.getClusteringObjForDateType(a,b,d),c=a.notNullLabel,e=a.nullLabel):(c=this.separateFeaturesWhetherFieldValueNull(a,b),b=c.nullLabelFeatures,c=this.getClusteringObjByField(c.notNullLabelFeatures,a),e=this.getClusteringObjByField(b,a));return{notNullLabel:c,nullLabel:e}},calcValueByOperation:function(a,b,d){if(a&&1===a.length){if(!d)return a[0];if(!this._isNumber(a[0]))return 0}var c;if(0!==a.length){c=0;"max"===b?c=-Infinity:"min"===b&&(c=Infinity);a=d?a.map(function(a){this._isNumber(a)||
(a=0);return a}.bind(this)):a.filter(function(a){return this._isNumber(a)}.bind(this));var e=0;a.forEach(q.hitch(this,function(a){e++;"average"===b||"sum"===b?c+=a:"max"===b?c=Math.max(c,a):"min"===b&&(c=Math.min(c,a))}));0<e?"average"===b&&(c/=e):c=null}else c=null;return c},getClusteringObjByField:function(a,b){var d={};a.forEach(q.hitch(this,function(a){var c=a.attributes,c=c&&c[b],g=typeof c,c=this.convertingNullOrUndefinedAsPlaceholders(c),h=null;d.hasOwnProperty(c)?(h=d[c],h.features.push(a),
h.count++):(h={count:1,features:[a],type:g},d[c]=h)}));return d},_removeNaNDataItem:function(a){return a.filter(function(a){var b=!1;a=a.category;"number"===typeof a&&(b=isNaN(a));return!b})},separateFeaturesWhetherFieldValueNull:function(a,b){var d=[],c=[];Array.isArray(b)&&(c=b.filter(function(b){var c=b.attributes,c=c&&c[a];if(null===c||void 0===c)d.push(b);else return!0}));return{nullLabelFeatures:d,notNullLabelFeatures:c}},getStartTimeByUnit:function(a,b){return l(a).startOf(b).utc().valueOf()},
_mosaicFieldNameWithOperatorAndUpper:function(a,b){return n.upperCaseString(a+"_"+b)},_mosaicFieldNameWithOperatorAndLower:function(a,b){return n.lowerCaseString(a+"_"+b)},getClusteringObjForDateType:function(a,b,d){function c(a,b,c){a[b]?(a=a[b],a.count+=c.count,a.features=a.features.concat(c.features)):a[b]=c}function e(a,b,c,d){b=Number(b);d=this.getStartTimeByUnit(b,d);a[d]?(a=a[d],a.count+=c.count,a.features=a.features.concat(c.features)):(c.originTime=b,a[d]=c)}function g(a,b,c){c[a[0].attributes[b]]=
{count:1,features:a};return c}var h=this.separateFeaturesWhetherFieldValueNull(a,b),m=h.notNullLabelFeatures;b={};b=this.getClusteringObjByField(h.nullLabelFeatures,a);h={};if(1===m.length)h=g.call(this,m,a,h,d);else if(0!==m.length){var f=this._getTimeTwixs(m,a,d.minPeriod);if(f){var p={},n=f.dateUnit;f.twixs.forEach(function(b){var e="undefined"!==typeof b.startValue?b.startValue:b.start().valueOf(),g="undefined"!==typeof b.endValue?b.endValue:b.end().valueOf(),f={unit:n,count:0,features:[]};m.forEach(q.hitch(this,
function(b){var c=b.attributes,c=c&&c[a];c>=e&&c<g&&(f.features.push(b),f.count++)}));d.isNeedFilled?c.call(this,p,e,f):0<f.count&&c.call(this,p,e,f)}.bind(this));var f={},k,l;for(k in p)p.hasOwnProperty(k)&&(l=p[k],e.call(this,f,k,l,n));for(k in f)if(f.hasOwnProperty(k)){l=f[k];var r=l.originTime;delete l.originTime;h[r]=l}}else h=g.call(this,m,a,h,d)}return{notNullLabel:h,nullLabel:b}},_mapOptions:function(a,b){"feature"===b?(b=a.labelField,delete a.labelField,a.clusterField=b,a.showNullLabelData=
!0):"category"===b?(b=a.categoryField,delete a.categoryField,a.clusterField=b,a.showNullLabelData=!0):"count"===b?(b=a.categoryField,delete a.categoryField,a.clusterField=b):"field"===b&&(a.showNullLabelData=!0);return a},_mapDataItemForStatisticsChart:function(a,b){var d,c,e;return a.map(function(a){d=a.label;delete a.label;c=a.values;delete a.values;e=a.features;delete a.features;"feature"===b?(a.category=d,a.valueFields=c,a.dataFeatures=e):"category"===b?(a.category=d,a.valueFields=c,a.dataFeatures=
e):"count"===b?(a.fieldValue=d,a.count=c[0],a.dataFeatures=e):"field"===b&&(a.label=d,a.value=c[0]);return a})},getFeatureModeStatisticsInfo:function(a){var b=new r({featureLayer:a.layerDefinition,popupInfo:a.popupFieldInfosObj});a=this._mapOptions(a,"feature");var d=a.clusterField,c=this.getFeatureModeStatisticsData(a),c=this.sortStatisticsData(c,"feature",a.sortOrder,d),c=this.getDataForMaxLabels(c,a.maxLabels),c=b.getBestLabelDisplay(c,d,"feature"),c=b.keepStatisticsDataBestDecimalPlace(a,c,"feature");
return this._mapDataItemForStatisticsChart(c,"feature")},getCategoryModeStatisticsInfo:function(a){var b=new r({featureLayer:a.layerDefinition,popupInfo:a.popupFieldInfosObj});a=this._mapOptions(a,"category");var d=a.clusterField,c=this.getCategoryModeStatisticsData(a),c=this.sortStatisticsData(c,"category",a.sortOrder,null,a.valueFields),c=this._removeNaNDataItem(c),c=this.getDataForMaxLabels(c,a.maxLabels),c=b.getBestLabelDisplay(c,d,"category"),c=b.keepStatisticsDataBestDecimalPlace(a,c,"category");
return this._mapDataItemForStatisticsChart(c,"category")},getCountModeStatisticsInfo:function(a){var b=new r({featureLayer:a.layerDefinition,popupInfo:a.popupFieldInfosObj});a=this._mapOptions(a,"count");var d=a.clusterField,c=this.getCountModeStatisticsData(a),c=this.sortStatisticsData(c,"count",a.sortOrder),c=this.getDataForMaxLabels(c,a.maxLabels),c=b.getBestLabelDisplay(c,d,"count");return this._mapDataItemForStatisticsChart(c,"count")},getFieldModeStatisticsInfo:function(a){var b=new r({featureLayer:a.layerDefinition,
popupInfo:a.popupFieldInfosObj});a=this._mapOptions(a,"category");var d=this.getFieldModeStatisticsData(a),d=this.sortStatisticsData(d,"field",a.sortOrder),d=this.getDataForMaxLabels(d,a.maxLabels),d=b.getBestLabelDisplay(d,null,"field"),d=b.keepStatisticsDataBestDecimalPlace(a,d,"field");return this._mapDataItemForStatisticsChart(d,"field")}}});