// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/Deferred dojo/DeferredList jimu/utils esri/request esri/geometry/webMercatorUtils jimu/portalUtils jimu/tokenUtils jimu/dijit/Message esri/layers/FeatureLayer esri/graphic".split(" "),function(r,d,k,h,m,t,l,u,v,n,p,w,q){return r("Snapshot",null,{_portal:null,_portalUrl:"",_layerArray:[],_originMapId:"",_originAppId:"",_credential:null,name:"",appendTimeStamp:null,baseMap:null,tags:"",description:"",shareWith:null,logo:"",time:null,constructor:function(a,
b){this.map=b;this.appConfig=a;this._originAppId=a.appId;this._originMapId=b.itemId;this._mapItemInfo=b.itemInfo;this._portalUrl=a.portalUrl;this._portal=v.getPortal(this._portalUrl);this._baseUrl=this._portalUrl+"sharing/rest/";this.nls=d.mixin({},window.jimuNls.drawBox,window.jimuNls.snapshot)},createSnapShot:function(a){this.ids=[];this.layerArray=[];this.time=this._getDateString(Date.now());this.name=(a.appendTimeStamp&&a.name?a.name+"_"+this.time:a.name)||this._mapItemInfo.item.title+"_"+this.time;
this.extent=a.mapExtent||this.map.extent;this.logo=a.logo||this.appConfig.logo;this.mapName=a.mapTitle||this.name;this.shareWith=a.shareWith||{everyone:!1,org:!1,groups:""};var b=a.folderOptions;b.name=a.folderOptions.name||this.name;b.title=a.folderOptions.title||this.name;b.description=a.folderOptions.description||this.name;a=a.data.reverse();return this._createSnapshot(b,a)},_createSnapshot:function(a,b){var c=new h;this._portal.getUser().then(d.hitch(this,this._processUser),function(a){c.reject(a)}).then(d.hitch(this,
this._createFolder,a),function(a){c.reject(a)}).then(d.hitch(this,this._createItems,b),function(a){c.reject(a)}).then(d.hitch(this,this._addLayers),function(a){c.reject(a)}).then(d.hitch(this,this._createMap,this._mapItemInfo),function(a){c.reject(a)}).then(d.hitch(this,this._processMap),function(a){c.reject(a)}).then(d.hitch(this,this._shareItems),function(a){c.reject(a)}).then(d.hitch(this,this._showMessage),function(a){c.reject(a)}).then(function(){c.resolve()});return c},_processUser:function(a){var b=
new h;this.user=a;this.groups=a.groups;b.resolve();return b},_createFolder:function(a){var b=new h;a={url:this._baseUrl+"content/users/"+this.user.username+"/createFolder",content:d.mixin({f:"json"},a),handleAs:"json",callbackParamName:"callback"};this._isValidCredential()&&(a.content.token=this._credential.token);l(a,{usePost:!0}).then(d.hitch(this,function(a){a.success?((this.folder=a.folder)&&this.folder.id&&this.ids.push(this.folder.id),b.resolve(a.folder)):(console.log(a),b.reject(a))}),d.hitch(this,
function(a){b.reject(a)}));return b},_createItems:function(a){var b=new h,c=[];k.forEach(a,d.hitch(this,function(a){a.graphics&&0<a.graphics.length&&c.push(this._createLayerItem(a))}));var f=[];(new m(c)).then(d.hitch(this,function(a){for(var c=0;c<a.length;c++)!0===a[c][0]&&null!==a[c][1]&&f.push(a[c][1]);b.resolve(f)}),d.hitch(this,function(a){b.reject(a)}));return b},_addLayers:function(a){for(var b=new h,c=[],f=0;f<a.length;f++)c.push(this.user.addItem(a[f],this.folder.id));var g=[];(new m(c)).then(d.hitch(this,
function(a){for(var c=0;c<a.length;c++){var e=a[c][1];e.success&&(g.push(e.id),this.ids.push(e.id))}b.resolve(g)}),d.hitch(this,function(a){b.reject(a)}));return b},_createMap:function(a){for(var b=a.itemData,c=this.name,f=[],d=0;d<b.baseMap.baseMapLayers.length;d++){var e=b.baseMap.baseMapLayers[d];f.push({id:e.id,layerType:e.layerType,url:e.url,visibility:e.visibility,opacity:e.opacity,title:e.title,styleUrl:e.styleUrl,itemId:e.itemId})}b={baseMapLayers:f};f=[];for(d=0;d<this.layerArray.length;d++)e=
this.layerArray[d],f.push({id:e.layer.id,layerType:"ArcGISFeatureLayer",visibility:e.layer.visible,opacity:e.layer.opacity,title:e.layer.label,type:"feature",url:e.layer.url,popupInfo:e.layer.popupInfo});d=u.webMercatorToGeographic(this.extent);a={title:c,type:"Web Map",item:c,extent:d.xmin+","+d.ymin+","+d.xmax+","+d.ymax,text:JSON.stringify({operationalLayers:f,baseMap:b,spatialReference:this.map.spatialReference,version:a&&a.itemData&&a.itemData.version?a.itemData.version:"2.4"}),tags:this.name+
","+this.nls.snapshot_append,wabType:"HTML"};return this.user.addItem(a,this.folder.id)},_processMap:function(a){var b=new h;a.id&&this.ids.push(a.id);a.success?b.resolve(a.id):b.reject("fail");return b},_shareItems:function(a){var b=new h,c={url:this._baseUrl+"content/users/"+this.user.username+"/shareItems",content:{f:"json",everyone:this.shareWith.everyone,org:this.shareWith.org,items:this.ids.join(),groups:this.shareWith.groups,confirmItemControl:this._validateGroupItemControl(this.shareWith.groups)},
handleAs:"json",callbackParamName:"callback"};this._isValidCredential()&&(c.content.token=this._credential.token);l(c,{usePost:!0}).then(d.hitch(this,function(c){c.results&&0<c.results.length?b.resolve(this._portalUrl+"home/webmap/viewer.html?webmap\x3d"+a):b.reject("fail")}),d.hitch(this,function(a){b.reject(a)}));return b},_validateGroupItemControl:function(a){var b=a.split(",");return 0<this.groups.filter(function(a){var c=a.capabilities||[];return-1<b.indexOf(a.id)&&-1<c.indexOf("updateitemcontrol")}).length},
_showMessage:function(a){var b=new h;"fail"===a?(new p({message:this.nls.snapshot_failed}),b.reject(a)):(new p({message:'\x3ca href\x3d"'+a+'" target\x3d"_blank"\x3e'+this.nls.snapshot_complete+"\x3c/a\x3e"}),b.resolve("success"));return b},_getDateString:function(a){a=new Date(a);var b=a.getTimezoneOffset();return t.fieldFormatter.getFormattedDate(a,{dateFormat:"shortDateShortTime"})+" "+this.nls.utc+(0>b?"+"+Math.abs(b)/60:"-"+b/60)},_checkCredential:function(){var a=n.isValidCredential(this._credential);
a||this._clearCredential();return a},_isValidCredential:function(){this._updateCredential();return this._checkCredential()},_updateCredential:function(){this._checkCredential()||(this._credential=n.getPortalCredential(this._portalUrl))},_clearCredential:function(){this._credential=null},_createLayerItem:function(a){var b=new h,c={description:a.name,name:a.name,tags:[a.name],type:"Feature Service",title:a.name};this._createFeatureService(a.originalLayerName).then(d.hitch(this,function(f){if(f.success){var g=
f.serviceurl.replace(/rest/g,"rest/admin")+"/addToDefinition",e=this._createLayer(d.mixin(a,c));this._addDefinitionToService(g,e).then(d.hitch(this,function(d){d.success&&(d=new w(f.serviceurl+"/0?token\x3d"+this._credential.token,{id:c.name,outFields:["*"]}),c.url=f.serviceurl+"/0",this.layerArray.push({layer:{id:c.name,label:c.name,opacity:1,visible:!0,url:c.url,popupInfo:a.infoTemplate&&a.infoTemplate.info?a.infoTemplate.info:a.infoTemplate?a.infoTemplate:void 0}}),this._applyEditsOnLayer(d,a.graphics,
b,c))}),d.hitch(this,function(a){console.log(a.message);b.reject(null)}))}else b.reject(null)}),d.hitch(this,function(a){console.log(a.message);b.reject(null)}));return b},_applyEditsOnLayer:function(a,b,c,f){var g=[];k.forEach(b,function(a){a.attributes?g.push(new q(a.geometry,null,a.attributes)):g.push(new q(a.geometry,null,{}))},this);a.applyEdits(g,null,null).then(d.hitch(this,function(){c.resolve(f)})).otherwise(d.hitch(this,function(a){console.log(a.message);c.reject(null)}))},_createFeatureService:function(a){return l({url:this._portalUrl+
"sharing/content/users/"+this._credential.userId+"/createService",content:{f:"json",token:this._credential.token,typeKeywords:"ArcGIS Server,Data,Feature Access,Feature Service,Service,Hosted Service",createParameters:JSON.stringify(this._getFeatureServiceParams(a)),outputType:"featureService"},handleAs:"json",callbackParamName:"callback"},{usePost:!0})},_getFeatureServiceParams:function(a){return{name:a+"_"+(new Date).getTime(),serviceDescription:"",hasStaticData:!1,maxRecordCount:1E3,supportedQueryFormats:"JSON",
capabilities:"Create,Delete,Query,Update,Editing",tags:"",description:"",copyrightText:"",spatialReference:{wkid:102100},initialExtent:{xmin:this.map.extent.xmin,ymin:this.map.extent.ymin,xmax:this.map.extent.xmax,ymax:this.map.extent.ymax,spatialReference:{wkid:102100}},allowGeometryUpdates:!0,units:"esriMeters",xssPreventionInfo:{xssPreventionEnabled:!0,xssPreventionRule:"InputOnly",xssInputRule:"rejectInvalid"}}},_addDefinitionToService:function(a,b){return l({url:a,content:{token:this._credential.token,
addToDefinition:JSON.stringify(b),f:"json"},handleAs:"json",callbackParamName:"callback"},{usePost:!0})},_createLayer:function(a){var b=this.nls,c=a.graphics[0],d={point:"esriGeometryPoint",polyline:"esriGeometryPolyline",polygon:"esriGeometryPolygon"}["undefined"!==typeof c.geometry?c.geometry.type:c.type],c=c.symbol?c.symbol.toJson():"",g=[{name:"ObjectID",alias:"ObjectID",type:"esriFieldTypeOID"},{name:b.snapshot_append,alias:b.snapshot_append,type:"esriFieldTypeString"}];a.fields&&0<a.fields.length&&
k.forEach(a.fields,function(a){g.push({name:a.name,alias:a.alias,type:a.type,domain:a.domain})});b={xmin:this.extent.xmin,ymin:this.extent.ymin,xmax:this.extent.xmax,ymax:this.extent.ymax,spatialReference:this.extent.spatialReference};c=a.renderer&&a.renderer.toJson?a.renderer.toJson():a.renderer?JSON.stringify(a.renderer):{type:"simple",label:"",description:"",symbol:c};return{layers:[{adminLayerInfo:{geometryField:{name:"Shape"},xssTrustedFields:""},id:0,name:a.name,type:"Feature Layer",displayField:"",
description:a.description,tags:"SA",copyrightText:"",defaultVisibility:!0,ownershipBasedAccessControlForFeatures:{allowOthersToQuery:!1,allowOthersToDelete:!1,allowOthersToUpdate:!1},relationships:[],isDataVersioned:!1,supportsCalculate:!0,supportsAttachmentsByUploadId:!0,supportsRollbackOnFailureParameter:!0,supportsStatistics:!0,supportsAdvancedQueries:!0,supportsValidateSql:!0,supportsCoordinatesQuantization:!0,supportsApplyEditsWithGlobalIds:!0,advancedQueryCapabilities:{supportsPagination:!0,
supportsQueryWithDistance:!0,supportsReturningQueryExtent:!0,supportsStatistics:!0,supportsOrderBy:!0,supportsDistinct:!0,supportsQueryWithResultType:!0,supportsSqlExpression:!0,supportsReturningGeometryCentroid:!0},useStandardizedQueries:!1,geometryType:d,minScale:0,maxScale:0,extent:b,drawingInfo:{renderer:c},allowGeometryUpdates:!0,hasAttachments:!1,htmlPopupType:"esriServerHTMLPopupTypeNone",hasM:!1,hasZ:!1,objectIdField:"OBJECTID",globalIdField:"",typeIdField:"",fields:this._getLayerFields(a.fields),
indexes:[],types:[],templates:[{name:"New Feature",description:"",drawingTool:"esriFeatureEditToolPolygon",prototype:{attributes:{}}}],supportedQueryFormats:"JSON",hasStaticData:!1,maxRecordCount:1E4,standardMaxRecordCount:4E3,tileMaxRecordCount:4E3,maxRecordCountFactor:1,exceedsLimitFactor:1,capabilities:"Query,Editing,Create,Update,Delete"}]}},_getLayerFields:function(a){var b=[{name:"OBJECTID",type:"esriFieldTypeOID",actualType:"int",alias:"OBJECTID",sqlType:"sqlTypeOther",nullable:!1,editable:!1,
domain:null,defaultValue:null}];k.forEach(a,d.hitch(this,function(a){"esriFieldTypeString"===a.type&&(a.actualType="nvarchar",a.sqlType="sqlTypeNVarchar");b.push(a)}));return b}})});