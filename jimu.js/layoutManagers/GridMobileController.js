// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/html dojo/on dojo/aspect dojo/dom-construct dojo/dom-geometry dojo/dom-class dijit/_WidgetBase dijit/_TemplatedMixin jimu/PanelManager jimu/WidgetManager jimu/utils".split(" "),function(q,f,g,m,k,n,h,p,e,r,t,u,v,w){return q([r,t],{baseClass:"jimu-dnd-mobile-controller",templateString:'\x3cdiv\x3e\x3cdiv class\x3d"icon-section" data-dojo-attach-point\x3d"iconNode"\x3e\x3c/div\x3e\x3cdiv class\x3d"container-section" data-dojo-attach-point\x3d"containerNode"\x3e\x3c/div\x3e\x3c/div\x3e',
appConfig:null,panelContainerNode:null,openIds:null,toolsCount:0,panels:null,openPanelIds:null,widgetOnCloseHandlerIds:null,panelOnCloseHandlerIds:null,postCreate:function(){this.inherited(arguments);this.panelManager=u.getInstance();this.widgetManager=v.getInstance();this.openIds=[];this.openPanelIds=[];this.widgetOnCloseHandlerIds=[];this.panelOnCloseHandlerIds=[];this.panels={};this.createWidgetIcons();this.destroyUnusedPanels();0===this.toolsCount&&m.setStyle(this.domNode,"display","none");this.own(k(this.iconNode,
"click",f.hitch(this,function(a){a.stopPropagation();e.contains(this.containerNode,"in")?(e.remove(this.containerNode,"in"),e.add(this.containerNode,"out")):(e.remove(this.containerNode,"out"),e.add(this.containerNode,"in"))})));this.own(k(document.body,"click",f.hitch(this,function(a){e.contains(this.containerNode,"in")&&!this.isPartOfPopup(a.target||a.srcElement)&&(e.remove(this.containerNode,"in"),e.add(this.containerNode,"out"))})))},_isPanelUsed:function(a){var c;g.some(this.appConfig.widgetOnScreen.widgets,
f.hitch(this,function(d){if(d.inPanel&&a===d.id+"_panel")return c=d,!0}));return c},destroyUnusedPanels:function(){for(var a=[],c,d,b=0;b<this.panelManager.panels.length;b++)c=this.panelManager.panels[b].id,(d=this._isPanelUsed(c))?this.panelManager.panels[b].reloadWidget(d):a.push(c);g.forEach(a,f.hitch(this,function(a){this.panelManager.destroyPanel(a)}))},destroyOnScreenWidgets:function(){g.forEach(this.appConfig.widgetOnScreen.widgets,function(a){a.inPanel?this.panelManager.destroyPanel(a.id+
"_panel"):this.widgetManager.destroyWidget(a.id)},this)},isPartOfPopup:function(a){var c=this.containerNode;return a===c||m.isDescendant(a,c)},setConfig:function(a){this.appConfig=a;this.createWidgetIcons()},createWidgetIcons:function(){this.toolsCount=0;h.empty(this.containerNode);this.appConfig&&this.appConfig.widgetOnScreen&&g.forEach(this.appConfig.widgetOnScreen.widgets,function(a){a.uri&&a.closeable&&(this._addItem(a),this.toolsCount++)},this)},_pushId:function(a){this._popId(a);this.openPanelIds.push(a)},
_popId:function(a,c){a=this.openPanelIds.indexOf(a);0<=a&&(this.openPanelIds.splice(a,1),c&&0<this.openPanelIds.length&&(c=this.openPanelIds[this.openPanelIds.length-1],this.panelManager.openPanel(c)))},_addItem:function(a){var c=f.clone(a),d=h.create("div",{"class":"row"},this.containerNode);h.create("div",{"class":"widget-icon column",style:"background: url("+a.icon+") no-repeat;"},d);h.create("div",{"class":"widget-label jimu-ellipsis column",title:a.label,innerHTML:w.sanitizeHTML(a.label)},d);
this.own(k(d,"click",f.hitch(this,function(b){var l;b.stopPropagation();a.inPanel?(b=p.getMarginBox(this.panelContainerNode),l=window.isRTL?{relativeTo:"browser",right:b.l,top:b.t,width:b.w,height:b.h}:{relativeTo:"browser",left:b.l,top:b.t,width:b.w,height:b.h},c.panel={uri:"themes/DashboardTheme/panels/OnScreenPanel/Panel",position:l},this.panelManager.showPanel(c).then(f.hitch(this,function(a){this.panels[a.id]=a;this._pushId(a.id);a.setPosition(l);0>this.panelOnCloseHandlerIds.indexOf(a.id)&&
(this.own(n.after(a,"onClose",f.hitch(this,function(){this._popId(a.id,!0)}))),this.panelOnCloseHandlerIds.push(a.id));return a})).then(f.hitch(this,function(a){this.panelManager.openPanel(a)}))):(b=p.getMarginBox(d),this._toggleOffPanelWidget(a,b.l+b.w,b.t));e.remove(this.containerNode,"in");e.add(this.containerNode,"out")})))},_toggleOffPanelWidget:function(a,c,d){var b=this.openIds.indexOf(a.id);0<=b?(this.widgetManager.closeWidget(a.id),this.openIds.splice(b,1)):this.widgetManager.loadWidget(a).then(f.hitch(this,
function(e){this.openIds.push(a.id);e.setPosition({left:c,top:d,zIndex:100,relativeTo:"map"});this.widgetManager.openWidget(e);0>this.widgetOnCloseHandlerIds.indexOf(a.id)&&(this.own(n.after(e,"onClose",f.hitch(this,function(){b=this.openIds.indexOf(a.id);0<=b&&this.openIds.splice(b,1)}))),this.widgetOnCloseHandlerIds.push(a.id))}))},setPanelPosition:function(a){g.forEach(this.openPanelIds,f.hitch(this,function(c,d){d===this.openPanelIds.length-1&&(a.zIndex=101);"opened"!==this.panels[c].state&&"active"!==
this.panels[c].state||this.panels[c].setPosition(a,!0)}))}})});