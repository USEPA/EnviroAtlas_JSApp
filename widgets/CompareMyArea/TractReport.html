<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

      <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
      <title>Compare My Area | EnviroAtlas | US EPA</title>
      <link rel="stylesheet" href="https://js.arcgis.com/3.24/dijit/themes/claro/claro.css">
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
      <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/dojo/1.10.4/dojo/resources/dojo.css" />
      <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/dojo/1.10.4/dojox/grid/resources/claroGrid.css" />
      <style>
		td, th {
			border: 1px solid #5b616b;
			padding: 0.88235em;
		}
		.arrow_right {
			background: #CCFFFF url(images/arrow_right.png) no-repeat left !important;
		}
		.arrow_down {
			background: #CCFFFF url(images/arrow_down.png) no-repeat left !important;
		}
		.panel-title > a {
			text-decoration: none;
		}
		.panel-group {
			margin-bottom: 0;
		}
		.panel-body {
			padding: 0;
		}
		.chart {
			width: 96%;
			height: 500px;
		}
		.legend {
			width: 96%;
			text-align: center;
		}
		.dojoxLegendNode td {
			border-width: 0 !important;
		}
		.gridtable {

			width: 96%;
			height: auto;
		}
		.claro .dojoxGrid {
			border-width: 0 !important;
		}
		button {
			font-size: 12px;
		}
		.note {
			font-size: 9pt;
			font-style: italic;
		}
		/* .panel-title > a:after {
		 content: "\2212";
		 float: right!important;
		 position: relative;
		 top: 1px;
		 display: inline-block;
		 font-family: 'Glyphicons Halflings';
		 font-style: normal;
		 font-weight: normal;
		 line-height: 1;
		 }
		 .panel-title > a.collapsed:after {
		 content: "\002b";
		 }

		 .panel-default > .panel-heading {
		 background-color: #CCFFFF;
		 } */
      </style>
      <script src="https://js.arcgis.com/3.24/"></script>

      <script>
      require([
        "dojo/dom", "dojo/on","dojo/promise/all",
        './configLocal.js',
        "esri/tasks/query", "esri/tasks/QueryTask",
        "esri/tasks/PrintTask","esri/tasks/PrintParameters","esri/tasks/PrintTemplate",
        'dojox/grid/DataGrid',
'dojo/data/ItemFileWriteStore',
'dojox/charting/Chart',
'dojox/charting/plot2d/ClusteredColumns',
'dojox/charting/plot2d/ClusteredBars',
'dojox/charting/widget/SelectableLegend',
'dojox/charting/action2d/Highlight',
'dojox/charting/action2d/Tooltip',
'dojox/charting/plot2d/Grid',
'dojox/charting/plot2d/Markers',
'dojox/charting/axis2d/Default',
'dojox/gfx/utils',
 "dojo/domReady!"
      ], function (dom, on,all,_config, Query, QueryTask,PrintTask, PrintParameters, PrintTemplate,DataGrid,ItemFileWriteStore,
      Chart,ClusteredColumns,ClusteredBars,SelectableLegend,Highlight,Tooltip) {
            var tractid = getQueryVariable('tract');
            if ((!(tractid)) || (tractid.length != 11)) {
                alert("Please pass in 11-digits Tract ID!");
                document.write('<script type="text/javascript">');
                window.stop();
                if (( i = navigator.userAgent.indexOf('MSIE')) >= 0) {
                    document.execCommand("Stop");
                };
            }

            var defTab = "demog";
            var cmamap = _config.nata.mapurl;
            var enotestr = _config.nata.enote;
            var acsmapurl = _config.demog.mapurl;
            var nataLayers = _config.nata.natalayers;
            var demogLayers = _config.demog.demoglayers;
            var themeObj = _config.themeObj;
            themeObj[defTab].status = true;
            var acsfields = [];
            for (var a in themeObj["demog"].fields) {
                acsfields.push(a);
            }

            var hastable = false;

            var queryArray = [];
            var demogqueryArray = [];
            var query = new Query();

            query.outFields = ['*'];
            var dquery = new Query();
            dquery.returnGeometry = false;
            dquery.outFields = acsfields;

            processDemog();
            processNata();

            //document.getElementById("expodiv").innerHTML = 'loading...';
            $('.nav-tabs a').on('shown.bs.tab', function(event) {
                var themeid = event.target.id;

                if (themeid == 'dtable') {
                if (!(hastable)) generateTable();
                } else if (themeid == 'risk') {
                    $('input[name="risktype"]').each(function() {
                        var t = this.value;
                        var ldivid = themeObj[themeid].subsets[t].divid;

                        if (this.checked) {
                            var subtheme = this.value;
                            dojo.byId("ejchartNode" + ldivid).style.display = "block";
                            dojo.byId("ejlegendNode" + ldivid).style.display = "block";
                            dojo.byId("ejTableNode" + ldivid).style.display = "block";
                            dojo.byId('notediv2').innerHTML = themeObj[themeid].subsets[subtheme].note;
                        if (!(themeObj[themeid].subsets[subtheme].hasChart)) generateChart(themeid);
                        } else {
                            dojo.byId("ejchartNode" + ldivid).style.display = "none";
                            dojo.byId("ejlegendNode" + ldivid).style.display = "none";
                            dojo.byId("ejTableNode" + ldivid).style.display = "none";
                        }
                    });
                } else {
                if (!(themeObj[themeid].hasChart)) generateChart(themeid);
                }
            });

            $('input[name="risktype"]').each(function() {
                this.onclick = switchAction;
            });
            function switchAction(e) {
                var subtheme = e.target.value;

                for (var s in themeObj["risk"].subsets) {
                    var ldivid = themeObj["risk"].subsets[s].divid;
                    if (s == subtheme) {
                        dojo.byId("ejchartNode" + ldivid).style.display = "block";
                        dojo.byId("ejchartNode" + ldivid).style.width = "100%";
                        dojo.byId("ejlegendNode" + ldivid).style.display = "block";
                        dojo.byId("ejTableNode" + ldivid).style.display = "block";
                        dojo.byId('notediv2').innerHTML = themeObj['risk'].subsets[s].note;
                        if (!(themeObj["risk"].subsets[subtheme].hasChart))
                            generateChart("risk");
                    } else {
                        dojo.byId("ejchartNode" + ldivid).style.display = "none";
                        dojo.byId("ejlegendNode" + ldivid).style.display = "none";
                        dojo.byId("ejTableNode" + ldivid).style.display = "none";
                    }
                }
            }

            function getQueryVariable(variable) {
                var query = window.location.search.substring(1);
                var vars = query.split("&");
                for (var i = 0; i < vars.length; i++) {
                    var pair = vars[i].split("=");
                    if (pair[0].toLowerCase() == variable.toLowerCase()) {
                        return pair[1];
                    }
                } // end of for loop
            }

            function processNata() {

                var tractwhere = nataLayers['tract'].idfield + "='" + tractid + "'";
                var countywhere = nataLayers['county'].idfield + "='" + tractid.substr(0, 5) + "'";
                var stwhere = nataLayers['state'].idfield + "='" + tractid.substr(0, 2) + "'";
                pushQuery(nataLayers['tract'].layerid, tractwhere);
                pushQuery(nataLayers['county'].layerid, countywhere);
                pushQuery(nataLayers['state'].layerid, stwhere);

                var promises = all(queryArray);
                promises.then(handleNataResults);
            }

            function processDemog() {
                var tractwhere = demogLayers['tract'].idfield + "='" + tractid + "'";
                var countywhere = demogLayers['county'].idfield + "='" + tractid.substr(0, 5) + "'";
                var stwhere = demogLayers['state'].idfield + "='" + tractid.substr(0, 2) + "'";
                pushDemogQuery(demogLayers['tract'].layerid, tractwhere);
                pushDemogQuery(demogLayers['county'].layerid, countywhere);
                pushDemogQuery(demogLayers['state'].layerid, stwhere);
                var promises = all(demogqueryArray);
                promises.then(handleDemogResults);
            }

            function handleDemogResults(results) {
                var demogFieldObj = themeObj["demog"].fields;
                for (var dfield in demogFieldObj) {
                    var is_pop_count = demogFieldObj[dfield].cumulate;
                    if (results[0].features.length > 0) {
                        var tractatts = results[0].features[0].attributes;
                        var dvalue = tractatts[dfield];
                        if (dvalue == null) {
                            demogFieldObj[dfield]["tract"] = dvalue;
                        } else if (is_pop_count) {
                            demogFieldObj[dfield]["tract"] = dvalue.toLocaleString(undefined, {
                                minimumFractionDigits : 0
                            });
                        } else {
                            demogFieldObj[dfield]["tract"] = dvalue.toFixed(1);
                        }
                    }
                    if (results[1].features.length > 0) {
                        var cntyatts = results[1].features[0].attributes;
                        var dvalue = cntyatts[dfield];
                        if (dvalue == null) {
                            demogFieldObj[dfield]["county"] = dvalue;
                        } else if (is_pop_count) {
                            demogFieldObj[dfield]["county"] = dvalue.toLocaleString(undefined, {
                                minimumFractionDigits : 0
                            });
                        } else {
                            demogFieldObj[dfield]["county"] = dvalue.toFixed(1);
                        }

                    }
                    if (results[2].features.length > 0) {
                        var statts = results[2].features[0].attributes;
                        var dvalue = statts[dfield];
                        if (dvalue == null) {
                            demogFieldObj[dfield]["state"] = dvalue;
                        } else if (is_pop_count) {
                            demogFieldObj[dfield]["state"] = dvalue.toLocaleString(undefined, {
                                minimumFractionDigits : 0
                            });
                        } else {
                            demogFieldObj[dfield]["state"] = dvalue.toFixed(1);
                        }

                    }

                }
            }

            function pushQuery(layerid, wherestr) {
                console.log(cmamap + "/" + layerid);
                query.returnGeometry = false;
                query.where = wherestr;
                var queryTask = new QueryTask(cmamap + "/" + layerid);
                queryArray.push(queryTask.execute(query));
            }

            function pushDemogQuery(layerid, wherestr) {
                console.log(acsmapurl + "/" + layerid);
                dquery.where = wherestr;
                var queryTask = new QueryTask(acsmapurl + "/" + layerid);
                demogqueryArray.push(queryTask.execute(dquery));
            }

            function handleNataResults(results) {
                try {
                    var tractatt = results[0].features[0].attributes;
                    var cntyatt = results[1].features[0].attributes;
                    var stateatt = results[2].features[0].attributes;
                    var tnamefld = nataLayers["tract"].namefield;
                    nataLayers["tract"].name = tractatt[tnamefld];
                    var cnamefld = nataLayers["county"].namefield;
                    nataLayers["county"].name = cntyatt[cnamefld]
                    var snamefld = nataLayers["state"].namefield;
                    nataLayers["state"].name = stateatt[snamefld];

                    dojo.byId('tractid').innerHTML = 'Census Tract: ' + tractid + '<br>' + cntyatt.NAME10 + ' County, ' + stateatt.NAME10;

                    for (var theme in themeObj) {

                        if (themeObj[theme].isNATA) {
                            if (themeObj[theme].subsets) {
                                for (var subtheme in themeObj[theme].subsets) {
                                    var fldobj = themeObj[theme].subsets[subtheme].fields;
                                    for (var fld in fldobj) {
                                        var d = Number(fldobj[fld].digits);
                                        var nvalue = tractatt[fld];
                                        if (nvalue != null) {
                                            if (Number(nvalue) < 0.00005) {
                                                fldobj[fld].tract = nvalue.toExponential(d);
                                                themeObj[theme].hasscinote = true;
                                            } else
                                                fldobj[fld].tract = nvalue.toFixed(d);
                                            //fldobj[fld].tract = nvalue.toFixed(d);
                                        } else {
                                            fldobj[fld].tract = null;
                                        }
                                        var cvalue = cntyatt[fld];
                                        if (cvalue != null) {
                                            if (Number(cvalue) < 0.00005) {
                                                fldobj[fld].county = cvalue.toExponential(d);
                                                themeObj[theme].hasscinote = true;
                                            } else
                                                fldobj[fld].county = cvalue.toFixed(d);
                                            //fldobj[fld].county = cvalue.toFixed(d);
                                        } else {
                                            fldobj[fld].county = null;
                                        }
                                        var svalue = stateatt[fld];
                                        if (svalue != null) {
                                            if (Number(svalue) < 0.00005) {
                                                fldobj[fld].state = svalue.toExponential(d);
                                                themeObj[theme].hasscinote = true;
                                            } else
                                                fldobj[fld].state = svalue.toFixed(d);
                                            //fldobj[fld].state = svalue.toFixed(d);
                                        } else {
                                            fldobj[fld].state = null;
                                        }
                                    }

                                }
                            } else if (themeObj[theme].fields) {
                                var fldobj = themeObj[theme].fields;
                                for (var fld in fldobj) {
                                    var d = Number(fldobj[fld].digits);
                                    var nvalue = tractatt[fld];
                                    if (nvalue != null) {
                                        if (Number(nvalue) < 0.00005) {
                                            fldobj[fld].tract = nvalue.toExponential(d);
                                            themeObj[theme].hasscinote = true;
                                        } else
                                            fldobj[fld].tract = nvalue.toFixed(d);
                                        //fldobj[fld].tract = nvalue.toFixed(d);

                                    } else {
                                        fldobj[fld].tract = null;
                                    }
                                    var cvalue = cntyatt[fld];
                                    if (cvalue != null) {
                                        if (Number(cvalue) < 0.00005) {
                                            fldobj[fld].county = cvalue.toExponential(d);
                                            themeObj[theme].hasscinote = true;
                                        } else
                                            fldobj[fld].county = cvalue.toFixed(d);
                                        //fldobj[fld].county = cvalue.toFixed(d);
                                    } else {
                                        fldobj[fld].county = null;
                                    }
                                    var svalue = stateatt[fld];
                                    if (svalue != null) {
                                        if (Number(svalue) < 0.00005) {
                                            fldobj[fld].state = svalue.toExponential(d);
                                            themeObj[theme].hasscinote = true;
                                        } else
                                            fldobj[fld].state = svalue.toFixed(d);
                                        //fldobj[fld].state = svalue.toFixed(d);
                                    } else {
                                        fldobj[fld].state = null;
                                    }
                                }
                            }

                        }

                    }
                    var scinote = false;
                    for (var t in themeObj) {
                        var notestr = '';
                        if (themeObj[t].note) {
                            notestr = themeObj[t].note;
                        }
                        if (themeObj[t].hasscinote) {
                            scinote = true;
                            notestr += enotestr;
                        }
                        var dvid = themeObj[t].divid;
                        var notedivid = "notediv" + dvid;
                        if (dojo.byId(notedivid))
                            dojo.byId(notedivid).innerHTML = notestr;

                        if (themeObj[t].status) {
                            $('.nav-tabs a[id="' + t + '"]').tab('show');
                            //generateChart(t);
                        }
                    }
                    if (scinote) {
                        if (dojo.byId("notediv5"))
                            dojo.byId("notediv5").innerHTML = enotestr;
                    }

                } catch (err) {
                    alert("error occurred when parsing NATA json result: " + err);
                }

            }

            function generateTable() {
                var tablegrid = "allgrid";
                // var button = document.createElement('button');
                // button.innerHTML = 'Download';
                // button.title = 'Download the data';
                // button.onclick = function(){
                //     download_csv(tablegrid);return false;
                // };
                // dojo.byId("gridDiv").appendChild(button);
                var subdata = {
                    identifier : "rowid",

                    items : []
                };
                var rowcount = 1;
                //for (var tm in themeObj) {
                for ( i = (Object.keys(themeObj).length) - 1; i >= 0; i--) {
                    var tm = Object.keys(themeObj)[i];
                    if (tm == "risk") {
                        for (var rm in themeObj[tm].subsets) {
                            var tdata = themeObj[tm].subsets[rm].fields;
                            for (var c in tdata) {
                                var recjson = {};
                                recjson["rowid"] = rowcount;
                                var ldesc = tdata[c].description;
                                //recjson["id"] = tm +"_" + c;
                                //console.log(tm + " -- " + ldesc + "--" + tdata["tract"][c]);
                                recjson["cat"] = themeObj[tm].subsets[rm].description + " (" + themeObj[tm].subsets[rm].unit + ")";
                                recjson["desc"] = ldesc;
                                recjson["tract"] = tdata[c]["tract"];
                                recjson["county"] = tdata[c]["county"];
                                recjson["state"] = tdata[c]["state"];
                                subdata.items.push(recjson);
                                rowcount = rowcount + 1;
                            }
                        }

                    } else {
                        if (themeObj[tm].fields) {
                            var tdata = themeObj[tm].fields;
                            for (var c in tdata) {
                                var recjson = {};
                                recjson["rowid"] = rowcount;
                                var ldesc = tdata[c].description;

                                //recjson["id"] = tm +"_" + c;
                                //console.log(tm + " -- " + ldesc + "--" + tdata["tract"][c]);

                                recjson["cat"] = themeObj[tm].description;
                                if (tm == 'demog' && (!(tdata[c].cumulate))) {
                                    recjson["desc"] = 'Percent ' + ldesc;
                                } else {
                                    recjson["desc"] = ldesc;
                                }

                                //recjson["desc"] = ldesc;
                                recjson["tract"] = tdata[c]["tract"];
                                recjson["county"] = tdata[c]["county"];
                                recjson["state"] = tdata[c]["state"];
                                //console.log(recjson)
                                subdata.items.push(recjson);
                                rowcount = rowcount + 1;
                            }
                        }
                    }
                }

                var store = new ItemFileWriteStore({
                    data : subdata
                });

                //console.log(subdata.items);

                var layout = [[
                //{ 'name': 'Row', 'field': 'rowid', 'width': '5%' },
                {
                    'name' : 'Category',
                    'field' : 'cat',
                    'width' : '30%'
                }, {
                    'name' : 'Variable',
                    'field' : 'desc',
                    'width' : '20%'
                }, {
                    'name' : 'Tract (' + tractid + ')',
                    'field' : 'tract',
                    'styles' : 'text-align:right;',
                    'width' : '15%'
                }, {
                    'name' : 'County (' + nataLayers["county"].name + ')',
                    'field' : 'county',
                    'styles' : 'text-align:right;',
                    'width' : '15%'
                }, {
                    'name' : 'State (' + nataLayers["state"].name + ')',
                    'field' : 'state',
                    'styles' : 'text-align:right;',
                    'width' : '15%'
                }]];

                /*create a new grid*/
                var grid = new DataGrid({
                    id : tablegrid,
                    store : store,
                    structure : layout,
                    canSort : false,
                    selectable : true,
                    autoHeight : 21
                    //style: "width:98%",
                    //escapeHTMLInData: false,
                    //rowSelector: '20px'
                });

                /*append the new grid to the div*/
                grid.placeAt("gridDiv");

                /*Call startup() to render the grid*/
                grid.startup();
                hastable = true;
            }

            function generateChart(theme) {
                var workobj;
                if (themeObj[theme].subsets) {
                    var subtheme = "";
                    $('input[name="risktype"]').each(function() {
                        if (this.checked)
                            subtheme = this.value;

                    });
                    //console.log("checked radio: " + subtheme);
                    workobj = themeObj[theme].subsets[subtheme];
                } else {
                    workobj = themeObj[theme];
                }
                if (workobj.fields) {
                    var chartobj = workobj.fields;
                    var s = workobj.divid;

                    //console.log("tract number:" + chartobj[Object.keys(chartobj)[0]]["tract"]);
                    //console.log("county number:" + chartobj[Object.keys(chartobj)[0]]["county"]);
                    //console.log("state number:" + chartobj[Object.keys(chartobj)[0]]["state"]);
                    var iForSettimeout = 0;
                    //  set your counter to 1

                    function myLoop() {
                        setTimeout(function() {
                            bStateNotReady = chartobj[Object.keys(chartobj)[0]]["state"] == undefined;
                            bCountyNotReady = chartobj[Object.keys(chartobj)[0]]["county"] == undefined;
                            bTractNotReady = chartobj[Object.keys(chartobj)[0]]["tract"] == undefined;
                            iForSettimeout++;
                            //  increment the counter
                            if ((iForSettimeout < 100) && (bStateNotReady || bCountyNotReady || bTractNotReady)) {//  if the counter < 100, and data is not ready
                                myLoop();
                                //  ..  again which will trigger another
                            } else {
                                var ctitle = workobj.description;
                                var unitstr = workobj.unit;
                                var tstr = workobj.xtitle;
                                var legendid = "ejlegendNode" + s;
                                var chartid = "ejchartNode" + s;

                                var chartTract = [];
                                var chartCounty = [];
                                var chartState = [];
                                var chartLabels = [];
                                for ( c = (Object.keys(chartobj).length) - 1; c >= 0; c--) {
                                    //for (var c in chartobj) {
                                    var obj = chartobj[Object.keys(chartobj)[c]];
                                    if (!(obj.cumulate)) {
                                        var ldesc = obj["description"];

                                        chartLabels.push(ldesc);
                                        chartTract.push(Number(obj["tract"]));
                                        chartCounty.push(Number(obj["county"]));
                                        chartState.push(Number(obj["state"]));
                                        //console.log(ldesc + ": " +obj["tract"]);
                                    }

                                }

                                chartDataObj = {
                                    "tractVals" : chartTract,
                                    "countyVals" : chartCounty,
                                    "stateVals" : chartState,
                                    "labels" : chartLabels
                                };

                                var xLabels = [];
                                for (var i = 0; i < chartDataObj.labels.length; i++) {
                                    xLabels.push({
                                        value : i + 1,
                                        text : chartDataObj.labels[i]
                                    });
                                }

                                levelegObj = {
                                    tract : {
                                        color : "#ff9966",
                                        highlight : "#ff5500",
                                        label : "Tract (" + tractid + ")"
                                    },
                                    county : {
                                        color : "#99cc66",
                                        highlight : "#557733",
                                        label : "County (" + nataLayers["county"].name + ")"
                                    },
                                    state : {
                                        color : "#3399ff",
                                        highlight : "#2266BB",
                                        label : "State (" + nataLayers["state"].name + ")"
                                    }

                                }

                                chart = new Chart(chartid, {
                                    title : ctitle,
                                    titlePos : "top",
                                    titleGap : 0,
                                    titleFont : "normal normal normal 12pt Tahoma",
                                    titleFontColor : "black",
                                    htmlLabels : false,
                                    margins : {
                                        l : 0,
                                        t : 0,
                                        r : 0,
                                        b : 0
                                    }

                                });

                                //main chart
                                chart.addPlot("default", {
                                    type : ClusteredBars,
                                    markers : true,
                                    gap : 5
                                });
                                //background lines on chart
                                chart.addPlot("grid", {
                                    type : dojox.charting.plot2d.Grid,
                                    hMajorLines : false,
                                    hMinorLines : false,
                                    vMajorLines : true,
                                    vMinorLines : false,
                                    width : 400,
                                    majorVLine : {
                                        color : "#D3D3D3",
                                        width : 1
                                    },
                                    renderOnAxis : false
                                });

                                chart.addAxis("x", {
                                    title : unitstr,
                                    htmlLabels : false,
                                    titleFont : "normal normal normal 9pt Tahoma",
                                    vertical : false,
                                    min : 0,
                                    titleOrientation : 'away'
                                });
                                //gridline fix: set max to 101 and fixUpper to marginsnor ticks. 100 cuts off top grid line. 101 adds bit of padding.
                                chart.addAxis("y", {
                                    title : tstr,
                                    htmlLabels : false,
                                    titleOrientation : "away",
                                    titleFont : "normal normal normal 9pt Tahoma",
                                    labels : xLabels,
                                    dropLabels : false,
                                    rotation : 0,
                                    font : "normal normal normal 7pt Verdana",
                                    vertical : true,
                                    fontColor : "#000000",
                                    majorTick : {
                                        length : 0
                                    },
                                    minorTick : {
                                        length : 0
                                    },
                                    majorTickStep : 1,
                                    minorTickStep : 0,
                                    minorLabels : false,
                                    titleOrientation : 'axis'
                                });
                                //set major tick to 1, minor to 0 so draws every step of data but doesn't fill in decimals between integers.

                                chart.addSeries(levelegObj.tract.label, chartDataObj.tractVals, {
                                    stroke : 'white',
                                    fill : levelegObj.tract.color
                                });
                                chart.addSeries(levelegObj.county.label, chartDataObj.countyVals, {
                                    stroke : 'white',
                                    fill : levelegObj.county.color
                                });
                                chart.addSeries(levelegObj.state.label, chartDataObj.stateVals, {
                                    stroke : 'white',
                                    fill : levelegObj.state.color
                                });

                                new dojox.charting.action2d.Highlight(chart, "default");
                                var pattern = "<span style='font-family:Verdana;font-size: 9px !important'><strong>{0}</strong><br>{1}:&nbsp;{2}</span>";
                                var tip = new dojox.charting.action2d.Tooltip(chart, "default", {
                                    text : function(o) {
                                        return dojo.replace(pattern, [o.run.name, xLabels[o.index].text, o.y]);
                                    }
                                });

                                chart.render();
                                var columnsLegend = new dojox.charting.widget.SelectableLegend({
                                    chart : chart,
                                    series : chart.series
                                }, legendid);

                                // var button = document.createElement('button');
                                //     button.innerHTML = 'Download';
                                //     button.title = 'Download the data';
                                //     button.onclick = function(){
                                //     download_csv('dgrid'+s);
                                //     return false;
                                // };
                                // dojo.byId("ejTableNode" + s).appendChild(button);
                                var tsubdata = {
                                    identifier : "trowid",
                                    items : []
                                };
                                var k = 1;
                                for (var c in workobj.fields) {
                                    var dobj = workobj.fields[c];
                                    // if (!(dobj.cumulate)) {
                                    var rowjson = {};
                                    rowjson["trowid"] = k;
                                    if (theme == 'demog' && (!(dobj.cumulate))) {
                                        rowjson["desc"] = 'Percent ' + dobj["description"];
                                    } else {
                                        rowjson["desc"] = dobj["description"];
                                    }
                                    rowjson["tract"] = dobj["tract"];
                                    rowjson["county"] = dobj["county"];
                                    rowjson["state"] = dobj["state"];
                                    tsubdata.items.push(rowjson);
                                    k = k + 1
                                    // }
                                }

                                var tstore = new ItemFileWriteStore({
                                    data : tsubdata
                                });
                                var tlayout = [[
                                //{ 'name': 'Row', 'field': 'trowid', 'width': '5%' },
                                {
                                    'name' : 'Variable',
                                    'field' : 'desc',
                                    'width' : '50%'
                                }, {
                                    'name' : 'Tract (' + tractid + ')',
                                    'field' : 'tract',
                                    'styles' : 'text-align:right;',
                                    'width' : '15%'
                                }, {
                                    'name' : 'County (' + nataLayers["county"].name + ')',
                                    'field' : 'county',
                                    'styles' : 'text-align:right;',
                                    'width' : '15%'
                                }, {
                                    'name' : 'State (' + nataLayers["state"].name + ')',
                                    'field' : 'state',
                                    'styles' : 'text-align:right;',
                                    'width' : '15%'
                                }]];
                                var tgrid = new DataGrid({
                                    id : 'dgrid' + s,
                                    store : tstore,
                                    structure : tlayout,
                                    canSort : false,
                                    selectable : true,
                                    autoHeight : true
                                    //style: "width:98%",
                                    //escapeHTMLInData: false,
                                    //rowSelector: '20px'
                                });
                                tgrid.placeAt("ejTableNode" + s);
                                tgrid.startup();
                                tgrid.resize();
                                workobj.hasChart = true;
                            }//else if data is ready

                        }, 1000);
                    }

                    myLoop();
                }
            }

            function download_csv(gridid) {

                var filename = "cma_" + gridid + ".csv";
                var grid = dijit.byId(gridid);
                var store = grid.store;
                store.fetch({
                    query : grid.query,
                    sort : grid.getSortProps(),
                    queryOptions : grid.queryOptions,
                    onComplete : function(items) {
                        var first_row = ['this is data from EnviroAtlas\n'];
                        dojo.forEach(grid.layout.cells, function(cell) {
                            first_row.push(cell.name);
                        });
                        var csv = first_row.join(',') + "\n";
                        //console.log(csv)
                        dojo.forEach(items, function(item, i) {
                            var result = [];
                            dojo.forEach(grid.layout.cells, function(cell) {
                                var itemstr = "\"" + cell.format(i, item) + "\"";
                                //itemstr = itemstr.replace(/,/g,";");
                                var itemstr = cell.format(i, item);
                                result.push(itemstr);
                            });

                            csv += result.join(',') + "\n";
                        });

                        if (window.navigator.msSaveOrOpenBlob) {
                            var blob = new Blob([csv]);
                            window.navigator.msSaveOrOpenBlob(blob, filename);
                        } else {
                            var hiddenElement = document.createElement('a');
                            hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
                            //hiddenElement.target = '_blank';
                            hiddenElement.download = filename;

                            document.body.appendChild(hiddenElement);
                            hiddenElement.click();
                        }
                    }
                });

            }

        });
      </script>
   </head>

   <body class="claro" style='background-color: lightgrey'>
      <div class="container" style='background-color: white'>
         <img id="CMA_bannerHUC" src="images/CompareMyArea_Header.png" style="width: 100%;" alt="CMA banner" />
         <br/>

         <!-- <span style="font-size: 32px;">Community Data Table Chart</span> -->
         <!-- <div id="imgDiv" style="text-align:center"></div> -->
         <hr>
         <center style='font-size:24px' id='tractid'></center>
         <!-- <center style='font-size: 12pt'><span id='tractnum'></span></center>
         <center style='font-size: 12pt'><span id='countyname'></span><span id='statename'></span></center> -->
         <hr>
         <ul class="nav nav-tabs">
            <li>
               <a data-toggle="tab" href="#menu3" id="demog">Demographic Indicators</a>
            </li>
            <li>
               <a data-toggle="tab" href="#menu2" id="risk">National Air Toxics Assessment</a>
            </li>
            <li>
               <a data-toggle="tab" href="#menu4" id="dtable">Data Table</a>
            </li>
         </ul>

         <div class="tab-content">
            <div id="home" class="tab-pane fade">
               <br />
               <p>
                  The National Emissions Inventory (NEI) is EPA’s comprehensive emissions inventory.
                  It is used to support air quality modeling and other activities within the Air Toxics Program.
                  The 2014 NEI, after review by State, Local, and Tribal agencies, was used as input to the AERMOD and
                  CMAQ models to generate ambient concentrations.
               </p>
               <div id="ejchartNode1" class="chart"></div>
               <br/>

               <center>
                  <div id="ejlegendNode1" class="legend"></div>
               </center>
               <div id="ejTableNode1" class="gridtable"></div>
               <br />
               <br />
               <div id="notediv1" class="note"></div>
               <br />
               <br />
               <br />
            </div>

            <div id="menu1" class="tab-pane fade">
               <br />
               <p>
                  The ambient concentrations were used as input to the inhalation exposure model (HAPEM7) to generate exposure concentrations.
                  Exposure modeling is an important step in this assessment because it takes into account that people move from one location to another
                  (e.g., from outside environments to inside environments).
               </p>

               <div id="ejchartNode2" class="chart"></div>
               <br />
               <center>
                  <div id="ejlegendNode2" class="legend"></div>
               </center>
               <div id="ejTableNode2" class="gridtable"></div>
               <br />
               <br />
               <!-- <div id="notediv2" class="note"></div> -->
               <br />
               <br />
               <br />
            </div>

            <div id="menu2" class="tab-pane fade">
               <br />
               <p>
                  These data were sourced from U.S. EPA <a href='https://www.epa.gov/national-air-toxics-assessment' target='_blank'>2014 National Air Toxics Assessment</a> (NATA). NATA calculates these air toxics concentrations and risks at the census tract level. It only includes outdoor sources of pollutants.

               </p>
               <div>
                  <div style='float:left; margin-right:9px'>
                     <input type="radio" name="risktype" value="amb_conc" checked>
                     Ambient Concentrations
                  </div>
                  <div style='float:left; margin-right:9px'>
                     <input type="radio" name="risktype" value="cancer">
                     Cancer Risk<sup>1</sup>
                  </div>
                  <div style='float:left; margin-right:9px'>
                     <input type="radio" name="risktype" value="resp">
                     Non-Cancer Respiratory Risk
                  </div>
                  <div>
                     <input type="radio" name="risktype" value="neuro">
                     Non-Cancer Neurological Risk
                  </div>
               </div>
               <br />
               <div id="notediv2" class="note"></div>
               <br />
               <div id="ejchartNode3-1" class="chart"></div>
               <div id="ejchartNode3-2" class="chart"></div>
               <div id="ejchartNode3-3" class="chart"></div>
               <div id="ejchartNode3-4" class="chart"></div>
               <br />
               <center>
                  <div id="ejlegendNode3-1" class="legend"></div>
                  <div id="ejlegendNode3-2" class="legend" style="display: none;"></div>
                  <div id="ejlegendNode3-3" class="legend" style="display: none;"></div>
                  <div id="ejlegendNode3-4" class="legend" style="display: none;"></div>
               </center>
               <div id="ejTableNode3-1" class="gridtable"></div>
               <div id="ejTableNode3-2" class="gridtable"></div>
               <div id="ejTableNode3-3" class="gridtable"></div>
               <div id="ejTableNode3-4" class="gridtable"></div>

               <div id="notediv3" class="note"></div>
               <br />
               <br />
               <br />
            </div>

            <div id="menu3" class="tab-pane fade">
               <br/>
               <p style='font-style:italic'>
                  These data are selected demographics from the 2014-2018 American Community Survey.
               </p>

               <div id="ejchartNode4" class="chart"></div>
               <br />
               <center>
                  <div id="ejlegendNode4" class="legend"></div>
               </center>
               <div id="ejTableNode4" class="gridtable"></div>
               <br>
               <div id="notediv4" class="note"></div>
               <br />

               <br />
            </div>

            <div id="menu4" class="tab-pane fade">
               <br/>
               <div id="gridDiv" style="width: 100%; height: 500px;"></div>

               <div id="notediv5" class="note"></div>
               <br />
               <br />
            </div>
         </div>
      </div>
   </body>
</html>

